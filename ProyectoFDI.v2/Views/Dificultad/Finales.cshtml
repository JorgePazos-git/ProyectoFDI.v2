@model IEnumerable<ProyectoFDI.v2.Models.DetalleCompetenciaDificultad>

@{
    ViewData["Title"] = "Finales";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>

<h1>RESULTADOS DIFICULTAD</h1>

<h4>Agregar Resultados</h4>
<hr />

<div class="row">
    <div class="col-md-4">
        @Html.Partial("_CompetenciaInfo")
    </div>
</div>
<hr />

<h4>Finales</h4>

<table class="table">
    <thead>
        <tr>
            <th>
                Puesto de Clasificacion
            </th>
            <th>
                Deportista
            </th>
            <th>
                Resultado Final
            </th>
            <th>
                Opciones
            </th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null)
        {
            @foreach (var item in Model.Where(m => m.IdCom == ViewBag.idcompetencia))
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.PuestoInicialRes)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.IdDepNavigation.NombresDep) @Html.DisplayFor(modelItem => item.IdDepNavigation.ApellidosDep)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.FinalRes)
                    </td>
                    <td>
                        <input type="button" class="agregar btn btn-info" data-id="@item.IdDetalleDificultad" value="Agregar Finales" />
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">GANADOR</h5>
        <button id="ganadorBtn" class="btn btn-primary" style="display: none;">Mostrar</button>

        <table id="tablaGanador" class="table" style="display: none;">
            <thead>
                <tr>
                    <th>Deportista</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button id="verResultadosBtn" class="btn btn-success" style="display: none;">Reporte</button>
    </div>
</div>

<script>
    // Manejar el clic en el botón "Agregar Clasificaciones"
    $(".agregar").click(function () {

        var botonAgregar = $(this);
        // Obtener el nombre del deportista de la fila actual
        var deportistaNombre = $(this).closest("tr").find("td:eq(1)").text();

        // Crear un formulario de entrada de datos para clasificaciones
        Swal.fire({
            title: 'Agregar Final',
            html:
                `<input id="final" class="swal2-input" placeholder="Resultado Final">`,
            showCancelButton: true,
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar',
            focusConfirm: false,
            preConfirm: () => {
                // Obtener los valores ingresados
                var final = document.getElementById('final').value;
                var idDetalle = botonAgregar.data("id");

                // Realizar una solicitud AJAX para enviar los valores al controlador
                $.ajax({
                    type: 'POST',
                    url: '/Dificultad/AgregarFinal', // Reemplaza 'TuControlador' con el nombre de tu controlador
                    data: {
                        idDetalle: idDetalle,
                        deportistaNombre: deportistaNombre,
                        final: final
                    },
                    success: function (response) {
                        if (response.success) {
                            // Actualizar el valor en la tabla
                            var fila = botonAgregar.closest("tr");
                            fila.find("td:eq(2)").text(final);

                            // Verificar si todos los resultados están llenos después de actualizar
                            verificarResultadosLlenos();

                            Swal.fire({
                                title: 'Resultados Guardados',
                                text: 'Los valores se han guardado correctamente en la base de datos.',
                                icon: 'success'
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: 'Hubo un error al guardar los valores.',
                                icon: 'error'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un error en la solicitud al servidor.',
                            icon: 'error'
                        });
                    }
                });
            }
        });
    });

    function verificarResultadosLlenos() {
        var todosLlenos = true;
        $("table tbody tr").each(function () {
            var final = $(this).find("td:eq(2)").text();
            if (final === "") {
                todosLlenos = false;
                return false; // Rompe el bucle si encuentra una fila incompleta
            }
        });

        // Muestra u oculta el botón en función de si todos los campos están llenos
        if (todosLlenos) {
            $("#ganadorBtn").show();
        } else {
            $("#ganadorBtn").hide();
        }
    }

    // Llama a la función al cargar la página para verificar el estado inicial
    verificarResultadosLlenos();
</script>

<script>
    $(document).ready(function () {
        // Función para asignar puestos y mostrar la tabla de deportistas ordenados
        function asignarPuestos() {
            $.ajax({
                type: 'POST',
                url: '/Dificultad/AsignarPuestosFinal', // Reemplaza 'TuControlador' con el nombre de tu controlador
                data: {
                    // Puedes enviar cualquier información adicional que necesites aquí
                    idCompetencia: @ViewBag.idcompetencia
                    },
                success: function (response) {
                    if (response.success) {
                        // Mostrar la tabla de deportistas ordenados
                        var tabla = $("#tablaGanador");
                        tabla.show();

                        // Limpiar la tabla (excepto la cabecera)
                        tabla.find("tbody tr").remove();

                        console.log(response.deportistas);

                        // Agregar los deportistas ordenados a la tabla
                        $.each(response.deportistas, function (index, deportista) {
                            var fila = `<tr><td>${deportista.idDepNavigation.nombresDep} ${deportista.idDepNavigation.apellidosDep}</td></tr>`;
                            tabla.find("tbody").append(fila);
                        });

                        Swal.fire({
                            title: 'Clasificaciones Guardadas',
                            text: 'Los valores se han guardado correctamente en la base de datos.',
                            icon: 'success',
                            html: 'Puestos calculados: '
                        });

                        // Ocultar el botón después de asignar los puestos
                        $("#ganadorBtn").hide();
                        $("#verResultadosBtn").show();
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un error al asignar los puestos.',
                            icon: 'error'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr.responseText);
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un error en la solicitud al servidor.',
                        icon: 'error'

                    });
                }
            });
        }

        // Manejar el clic en el botón "Guardar Resultados"
        $("#ganadorBtn").click(function () {
            asignarPuestos();
        });
    });
</script>

<script>
    $(document).ready(function () {
        // Manejar el clic en el botón "Reporte"
        $("#verResultadosBtn").click(function () {
            fetch('/Dificultad/ExportarExcel/' + @ViewBag.idcompetencia)
                .then(response => response.blob())
                .then(blob => {
                    // Descargar el archivo
                    const url = window.URL.createObjectURL(new Blob([blob]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', 'reporte.xlsx');
                    document.body.appendChild(link);
                    link.click();
                });
        });
    });

</script>

